<script>
    let allData = [];
    const vInp = document.getElementById('vSearch');
    const aInp = document.getElementById('aSearch');
    const vList = document.getElementById('vList');
    const resDiv = document.getElementById('results');
    let searchTimeout;

    // Fast CSV Loading
    Papa.parse("data.csv", {
        download: true,
        header: true,
        skipEmptyLines: true,
        worker: true, // Background mein load karega taaki site hang na ho
        complete: function(results) {
            allData = results.data.map(d => ({
                village: (d.VILLAGE || d.Village_Name || "").trim(),
                address: (d.SECTION_ADDRESS || d.Section_Address || "").trim(),
                part: d.PART_NO || d.Part_Number,
                sec: d.SECTION_NO || d.Section_Number
            }));

            // Duplicate hatane ke liye advanced Set
            const uniqueVillages = [...new Set(allData.map(item => item.village))].filter(v => v).sort();
            uniqueVillages.forEach(v => {
                let opt = document.createElement('option');
                opt.value = v;
                vList.appendChild(opt);
            });
            console.log("Data loaded successfully!");
        }
    });

    // Debounce Function: Taaki typing smooth ho
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300); // 0.3 second ka wait
    }

    function performSearch() {
        const v = vInp.value.toLowerCase().trim();
        const a = aInp.value.toLowerCase().trim();
        
        if(!v) {
            resDiv.innerHTML = "";
            return;
        }

        // Fast filtering
        const filtered = allData.filter(d => 
            d.village.toLowerCase() === v && 
            d.address.toLowerCase().includes(a)
        );

        // Result dikhane ka optimized tarika
        const htmlResults = filtered.map(d => `
            <div class="result-card">
                <div class="v-tag">${d.village}</div>
                <div class="badges">
                    <span class="badge p-badge">PART: ${d.part}</span>
                    <span class="badge s-badge">SEC: ${d.sec}</span>
                </div>
                <span class="address">ğŸ“ ${d.address}</span>
            </div>
        `).join('');

        resDiv.innerHTML = htmlResults || "<p style='color:white; text-align:center;'>Match nahi mila âŒ</p>";
    }

    vInp.addEventListener('input', debounceSearch);
    aInp.addEventListener('input', debounceSearch);
</script>